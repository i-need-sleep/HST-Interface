{% extends 'base.html'%}

{% block head %}

<!-- Magenta -->
<script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.21.0/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.0.0"></script>

<!-- Axios -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<!-- Keyboard, under construction -->
<script src="https://cdn.jsdelivr.net/npm/audiokeys@0.1.1/dist/audiokeys.min.js"></script>

<!-- D3, for overlaying the Magenta visualizer -->
<script src="https://d3js.org/d3.v6.min.js"></script>

<!-- Vue -->
<script src="https://unpkg.com/vue"></script>
<!-- Chord network -->
<script src=https://rawgit.com/emiliorizzo/vue-d3-network/master/dist/vue-d3-network.umd.js></script>

<title> Index </title>
{% endblock %}

{% block body %}

    <!-- Nav Bar -->
<nav class="navbar navbar-expand-sm bg-light">
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <button id='resample' class="btn">Resample</button><br> 
      </li>
      <!-- <li class="nav-item">
        <form method=post enctype=multipart/form-data action=/upload ckass="form form-inline">
            <div class="input-group">
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="customFile" name=user_midi>
                <label class="custom-file-label" for="customFile">Choose file</label>
            </div>
            <script>
                $(".custom-file-input").on("change", function() {
                  var fileName = $(this).val().split("\\").pop();
                  $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
                });
            </script>
            <span class="input-group-addon"></span>
            <input type=submit class="btn" value=Upload>
            </div>
        </form>
      </li> -->
  </ul>
  <ul class="navbar-nav">
      <li class="nav-item">
        <a tabindex="0" class="btn" role="button" data-toggle="popover" data-trigger="focus" title="Help" 
        data-content="Keyboard shortcuts: <br> 
        <ul>
          <li>w / ↑ : Apply the previous progression</li>
          <li>s / ↓ : Apply the next progression</li>
          <li>a / ← : Rewind by 1 second</li>
          <li>d / → : Fast forward by 1 second</li>
          <li>space / enter : Play / pause</li>
          <li>Hold shift: Toggle progression</li>
          <li>Hold ctrl: Toggle original</li>
        </ul>"  data-html="true">
          Help
        </a><br>
      </li>
  </ul>
  </div>
</nav>


<div class="container pt-3 pb-5" id="app">
    <!-- Time steps: Original -->
      <table id=time_steps class="table table-fixed prog_table">
        <thead class="thead-light">
        <tr>
            <th class = "prog_head table_cell"></th>
            {% for i in range(1,send['SAMPLE_LEN']+1) %}
            <th class= "time_cell" id="time{{i}}"> {{1+(i-1)//4}}.{{(i-1)%4+1}} </th>
            {% endfor %}
            <th></th>
        </tr>
        </thead>
    </table> 
    {% if send %}
        <!-- Visualizer: Original -->
        <div class="right">
        <midi-visualizer src="{{url_for('static',filename=send["midi_path"])}}" type="piano-roll" id="vis" class="midi_vis"></midi-visualizer>
        <svg class="original_svg svg" height="0px"></svg><br>
        </div><br>

        <!-- Original Progression -->
        <table id="original_prog" class="table table-hover table-fixed table-striped prog_table up">
          <tbody>
          <tr>
              <th id=play_prog_original class="prog_head">Original</th>
              {% for i in range(0,send['SAMPLE_LEN']) %}
              <th id="original_prog{{i}}" class="table_cell" style="font-weight:normal;"> {{ send["chords"][i] }} </td>
              {% endfor %}
              <th><button id=play_prog_original2 class="btn btn-light btn-sm">progression</button></th>
              <th></th>
          </tr>
          </tbody>  
      </table>

        
      
        <!-- Time steps: Altered -->
        <table id=time_steps_altered class="padded_up_time table table-fixed prog_table" hidden>
          <thead class="thead-light">
          <tr>
              <th class = "prog_head table_cell"></th>
              {% for i in range(1,send['SAMPLE_LEN']+1) %}
              <th class= "time_cell" id="time_altered{{i}}"> {{1+(i-1)//4}}.{{(i-1)%4+1}} </th>
              {% endfor %}
              <th></th>
          </tr>
          </thead>
        </table> 

        <!-- Visualizer: Altered -->
        <div id="swapped_player" class="right" hidden>
          <midi-visualizer type="piano-roll" id="vis_out" class="midi_vis up"></midi-visualizer>
          <svg class="swapped_svg svg" id="swapped_svg" height="0px"></svg><br>
        </div>

        <div id="main" class="padded_up">
          <!-- Altered Progression -->
            <table id=saved_prog class="table table-hover table-fixed table-striped prog_table" hidden>
              <tbody>
              </tbody>
            </table> 


            <p> Input chord: </p>
            <p id=chd_in_display hidden></p>

        <div class="row">

        <!-- Chord network -->
            <div class="col-9 container-fluid">
                    <p> 
                      Key = C major <br>
                      1 node = {{send["CHORD_LEN_QUANT"]}} beats
                    </p>
                <div id="graph">
                  <d3-network :net-nodes="nodes" :net-links="links" :options="options" @node-click="nodeClick":link-cb="lcb"/>
                  </d3-network>
                  <div class="row">
                  <!-- Root menu -->
                  <div class="col-3">
                  <table id=root_select hidden>
                    <thead class="table table-hover table-sm table-bordered">
                      <th>root</th>
                    </thead>
                  </table>
                  </div>
                  <!-- Bass/Chroma menu -->
                  <div class="col-3">
                  <table id=chroma_select hidden>
                    <thead class="table table-hover table-sm table-bordered">
                      <th>bass</th>
                      <th>chroma</th>
                    </thead>
                  </table>
                  </div>
                  </div>
                </div>
            </div>

            <div class="col-3" id="controls">
                <button id=rep_chd class="btn btn-light"> Add chord </button><br>
                <button id=play_chd class="quick_chd btn btn-light"> Play chord </button><br>
                <button id=sug_chd class="btn btn-light"> Suggest chord </button><br>
                <button id=edit_chd class="btn btn-light"> Edit chord </button><br><br>

                <button id=play_prog class="btn btn-light"> Play progression </button><br>
                <button id=clear_prog class="btn btn-light"> Clear progression </button><br><br>

                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                      <div class="input-group-text" style="width:160px">
                        <input type="checkbox" id="root_overlay" checked>  &nbsp Root overlay
                      </div>
                    </div>
                    <div class="input-group-prepend">
                      <div class="input-group-text" style="width:160px">
                        <input type="checkbox" id="chord_overlay" >  &nbsp Chord overlay
                      </div>
                    </div>
                  </div>

                  <input type=hidden id=chd_in name=chd_in value="{{chords}}">
                  <input type=hidden id=chd_in_send name="chd">
                  <button id=submit class="btn btn-primary">Save</button>
                
                <br>
                <div id=onScreenKeyboard>

                </div>
            </div> 
        </div>
        </div>

        <div id="swap_in_place" hidden>{{url_for('swap')}}</div>
        <div id="resample_url" hidden>{{url_for('resample')}}</div>

        <svg >
          <defs>
            <marker id="m-end" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" >
              <path d="M0,0 L0,6 L9,3 z"></path>
            <marker id="m-end-highlight" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" >
              <path d="M0,0 L0,6 L9,3 z"></path>
            </marker>
          </defs>
        </svg>
        

        
    {% endif %}
</div>


<!-- Original Player -->
      <midi-player class="up" id="player_original" src="{{url_for('static',filename=send["midi_path"])}}" sound-font visualizer="#vis"></midi-player>
      
<!-- Altered player -->
            <midi-player sound-font visualizer="#vis_out" id="player_out" hidden></midi-player>

<style>
  .prog_table{
    width: {{300+100*send["SAMPLE_LEN"]}}px !important;
}

</style>

<svg id=original_barline class="barline_svg"></svg>
<svg id=altered_barline class="barline_svg"></svg>

<script type="application/javascript"> 
  var swapped_chd = 0;

  var midi_path= '{{send["midi_path"]}}'
  var chords = '{{send["chords"]}}'
  var original_chd = JSON.parse('{{send["chd_mat"]|tojson}}')
  var SAMPLE_LEN = '{{send["SAMPLE_LEN"]}}';
  var CHORD_LEN_QUANT = '{{send["CHORD_LEN_QUANT"]}}';
</script>
<script type="application/javascript" src="{{url_for('static', filename='mainC.js')}}"></script>
    
{% endblock %}